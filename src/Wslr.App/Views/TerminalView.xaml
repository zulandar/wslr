<UserControl x:Class="Wslr.App.Views.TerminalView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:controls="clr-namespace:Wslr.App.Controls"
             xmlns:vm="clr-namespace:Wslr.UI.ViewModels;assembly=Wslr.UI"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance Type=vm:TerminalViewModel}"
             d:DesignHeight="450" d:DesignWidth="800">

    <Grid>
        <!-- Has tabs: show tab bar and terminal -->
        <Grid Visibility="{Binding HasTabs, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Tab bar -->
            <Border Grid.Row="0"
                    Background="{StaticResource OverlayLight5Brush}"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="0,0,0,1">
                <ScrollViewer HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Disabled"
                              Padding="4,4,4,0">
                    <StackPanel Orientation="Horizontal">
                        <ItemsControl ItemsSource="{Binding Tabs}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:TerminalTabViewModel}">
                                    <Border x:Name="TabBorder"
                                            CornerRadius="6,6,0,0"
                                            Padding="4,6,4,6"
                                            Margin="0,0,2,0"
                                            Cursor="Hand"
                                            Background="Transparent">
                                        <Border.InputBindings>
                                            <MouseBinding MouseAction="LeftClick"
                                                          Command="{Binding ActivateCommand}" />
                                            <MouseBinding MouseAction="MiddleClick"
                                                          Command="{Binding CloseCommand}" />
                                        </Border.InputBindings>
                                        <StackPanel Orientation="Horizontal">
                                            <!-- Status indicator -->
                                            <Ellipse Width="6" Height="6"
                                                     Margin="4,0,6,0"
                                                     VerticalAlignment="Center">
                                                <Ellipse.Style>
                                                    <Style TargetType="Ellipse">
                                                        <Setter Property="Fill" Value="{StaticResource MutedTextBrush}" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsConnected}" Value="True">
                                                                <Setter Property="Fill" Value="{StaticResource RunningBrush}" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding IsConnecting}" Value="True">
                                                                <Setter Property="Fill" Value="{StaticResource WarningBrush}" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Ellipse.Style>
                                            </Ellipse>

                                            <!-- Tab title -->
                                            <TextBlock Text="{Binding Title}"
                                                       VerticalAlignment="Center"
                                                       MaxWidth="120"
                                                       TextTrimming="CharacterEllipsis"
                                                       Margin="0,0,8,0">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock" BasedOn="{StaticResource BodyTextStyle}">
                                                        <Setter Property="Foreground" Value="{StaticResource SecondaryTextBrush}" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsActive}" Value="True">
                                                                <Setter Property="Foreground" Value="{StaticResource TextBrush}" />
                                                                <Setter Property="FontWeight" Value="SemiBold" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>

                                            <!-- Close button -->
                                            <Button Command="{Binding CloseCommand}"
                                                    VerticalAlignment="Center"
                                                    Padding="4"
                                                    Cursor="Hand"
                                                    ToolTip="Close tab (Ctrl+W)">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Background" Value="Transparent" />
                                                        <Setter Property="BorderThickness" Value="0" />
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border Background="{TemplateBinding Background}"
                                                                            CornerRadius="4"
                                                                            Padding="{TemplateBinding Padding}">
                                                                        <ContentPresenter />
                                                                    </Border>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="{StaticResource OverlayLight10Brush}" />
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                                <TextBlock Text="&#xE711;"
                                                           FontFamily="Segoe MDL2 Assets"
                                                           FontSize="10"
                                                           Foreground="{StaticResource SecondaryTextBrush}" />
                                            </Button>
                                        </StackPanel>
                                    </Border>
                                    <DataTemplate.Triggers>
                                        <DataTrigger Binding="{Binding IsActive}" Value="True">
                                            <Setter TargetName="TabBorder" Property="Background" Value="{StaticResource OverlayLight10Brush}" />
                                        </DataTrigger>
                                        <Trigger SourceName="TabBorder" Property="IsMouseOver" Value="True">
                                            <Setter TargetName="TabBorder" Property="Background" Value="{StaticResource OverlayLight10Brush}" />
                                        </Trigger>
                                    </DataTemplate.Triggers>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- Active tab toolbar -->
            <Border Grid.Row="1"
                    Background="{StaticResource OverlayLight5Brush}"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="12,8"
                    DataContext="{Binding ActiveTab}"
                    Visibility="{Binding IsConnected, Converter={StaticResource BoolToVisibilityConverter}, FallbackValue=Collapsed}">
                <DockPanel>
                    <!-- Right side buttons -->
                    <StackPanel DockPanel.Dock="Right"
                                Orientation="Horizontal">
                        <Button Content="Open in Windows Terminal"
                                Command="{Binding OpenInWindowsTerminalCommand}"
                                Style="{StaticResource SecondaryButtonStyle}"
                                Padding="12,6"
                                FontSize="12"
                                Margin="0,0,8,0" />
                        <Button Command="{Binding CloseCommand}"
                                Style="{StaticResource DangerButtonStyle}"
                                Padding="8,6"
                                ToolTip="Close tab">
                            <TextBlock Text="&#xE711;"
                                       FontFamily="Segoe MDL2 Assets"
                                       FontSize="12" />
                        </Button>
                    </StackPanel>

                    <!-- Left side: distribution name -->
                    <StackPanel Orientation="Horizontal"
                                VerticalAlignment="Center">
                        <TextBlock Text="&#xE756;"
                                   FontFamily="Segoe MDL2 Assets"
                                   FontSize="14"
                                   Foreground="{StaticResource RunningBrush}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0" />
                        <TextBlock Text="{Binding DistributionName}"
                                   Style="{StaticResource BodyStrongTextStyle}"
                                   VerticalAlignment="Center" />
                    </StackPanel>
                </DockPanel>
            </Border>

            <!-- Connecting state for active tab -->
            <StackPanel Grid.Row="2"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        DataContext="{Binding ActiveTab}"
                        Visibility="{Binding IsConnecting, Converter={StaticResource BoolToVisibilityConverter}, FallbackValue=Collapsed}">
                <TextBlock Text="&#xE895;"
                           FontFamily="Segoe MDL2 Assets"
                           FontSize="48"
                           Foreground="{StaticResource PrimaryBrush}"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,16" />
                <TextBlock Text="Connecting..."
                           Style="{StaticResource SubtitleTextStyle}"
                           HorizontalAlignment="Center" />
            </StackPanel>

            <!-- Terminal controls container - managed by code-behind -->
            <Grid x:Name="TerminalContainer"
                  Grid.Row="2"
                  Visibility="{Binding ActiveTab.IsConnected, Converter={StaticResource BoolToVisibilityConverter}, FallbackValue=Collapsed}" />
        </Grid>

        <!-- No tabs state: show welcome message -->
        <StackPanel HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Visibility="{Binding HasTabs, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
            <!-- Icon -->
            <TextBlock Text="&#xE756;"
                       FontFamily="Segoe MDL2 Assets"
                       FontSize="48"
                       Foreground="{StaticResource MutedTextBrush}"
                       HorizontalAlignment="Center"
                       Margin="0,0,0,16" />

            <!-- Title -->
            <TextBlock Text="Terminal"
                       Style="{StaticResource SubtitleTextStyle}"
                       HorizontalAlignment="Center"
                       Margin="0,0,0,8" />

            <!-- Message -->
            <TextBlock Text="Select a distribution from the list to open a terminal session."
                       Style="{StaticResource CaptionTextStyle}"
                       HorizontalAlignment="Center"
                       Margin="0,0,0,24" />

            <!-- Hint -->
            <TextBlock Style="{StaticResource CaptionTextStyle}"
                       HorizontalAlignment="Center"
                       Foreground="{StaticResource MutedTextBrush}">
                <Run Text="Tip: Click" />
                <Run Text="Terminal" FontWeight="SemiBold" />
                <Run Text="on a distribution card to connect." />
            </TextBlock>
        </StackPanel>

        <!-- Error overlay -->
        <Border HorizontalAlignment="Center"
                VerticalAlignment="Bottom"
                Margin="0,0,0,24"
                Visibility="{Binding ErrorMessage, Converter={StaticResource NullToVisibilityConverter}}">
            <Border Background="{StaticResource ErrorBackgroundBrush}"
                    CornerRadius="8"
                    Padding="16,12">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&#xE783;"
                               FontFamily="Segoe MDL2 Assets"
                               FontSize="14"
                               Foreground="{StaticResource ErrorTextBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0" />
                    <TextBlock Text="{Binding ErrorMessage}"
                               Foreground="{StaticResource ErrorTextBrush}"
                               Style="{StaticResource BodyTextStyle}"
                               VerticalAlignment="Center" />
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>
